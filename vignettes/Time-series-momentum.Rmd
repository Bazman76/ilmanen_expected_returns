---
title: '"Time Series Momentum"'
subtitle: "(draft)"
author: "Vito Lestingi"
date: "`r Sys.Date()`"
abstract: "This document includes replication material on some academic and practitioners' literature instrumental for our RGSoC 2020 project. The document itself is meant to be completely reproducible."
output:
  rmarkdown::pdf_document:
    citation_package: biblatex
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{"Time Series Momentum"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_knit$set(
  root.dir = normalizePath('..')
)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  warning = FALSE,
  error = FALSE
)

# Load libraries
library(xts)
library(plm)
```

```{r, echo=FALSE}
# Mentors, please feel free to add yourself to the authors' field if you wish.
```

# Introduction
\textcite{moskowitz-ooi-pedersen-2012} (MOP hereafter) study an asset pricing anomaly they name *time series momentum*, which is related but different from the *momentum* effect in that the latter has a cross-sectional relative nature with respect to assets clusters while the former is directly linked with single assets returns. They find the anomaly consistent both across different asset classes and markets. Also, they confirm this effect to be robust among more illiquid instruments.

# Data and methodology
TODO: Present data series we used, compare with analogies and differences with respect to data authors used.

# The cross-section of time series momentum
The excess returns 
$$
\frac{r_t^s}{\sigma_{t-1}^s} = \alpha + \beta_h\frac{r_{t-h}^s}{\sigma_{t-h-1}^s} + \epsilon_t^s
$$

where assets returns are scaled by their ex-ante volatility $\sigma_{t-1}^s$, with annualized variance being
$$
\sigma_t^2 = 261\sum_{i=0}^{\infty}(1 - \delta)\delta^i(r_{t-i-1} - \bar{r}_t)^2
$$
$\bar{r}_t$ returns exponentially weighted moving average (EWMA) and weight $\delta$ so that $\delta/(1 - \delta) = 60$ days.
Returns of TSMOM trading strategies on the instrument $s$ at month $t$ are systematically obtained considering the excess returns sign of $s$ over the past $k$ months and then acquiring or selling the instrument during the subsequent $h$ months. These two parameters determine a family of TSMOM strategies and are called *lookback period* and *holding period*, respectively.  
It follows that the strategy return at time $t$, defined $r_t^{\textrm{TSMOM}(k,h)}$, represents the average return across all instrument portfolios at that time, i.e. the return on the portfolio that was constructed in all observable past months. These returns are then average across all instruments include or within each asset class.

To explain these returns and assess whether they held abnormal performance, \textcite{moskowitz-ooi-pedersen-2012} study the regression specification
$$
r_t^{\textrm{TSMOM}(k,h)} = \alpha + \beta_{1}MSCI_{t} + \beta_{2}GSCI_{t} + \beta_{3}BOND_{t} + \beta_{4}SMB_{t} + \beta_{5}HML_{t} + \beta_{6}UMD_{t} + \epsilon_{t}
$$
where $MSCI$ is the MSCI World Index, $GSCI$ the S&P Goldman Sachs Commodity Index, $BOND$ is Barclay's Aggregate Bond Index ([Bloomberg Barclays Global Aggregate Index](https://data.bloomberglp.com/indices/sites/2/2016/08/Factsheet-Global-Aggregate.pdf) at the time of writing) and $SMB$, $HML$, $UMD$ are the usual Fama-French-Carhart factors. In what follows, given data series availability from authors, we study the TSMOM strategy with a 12 months lookback period and holding period of a month, that is $r_t^{\textrm{TSMOM}(12,1)}$, for each asset class and in the all assets aggregate.

```{r Load Factors and Portfolios Returns Data}
# TSM portfolios
parser.path <- file.path('inst', 'parsers', 'TSM.R')
source(parser.path)
TSM <- xts::xts(TSM[, -1], order.by=TSM$DATE)
# MSCI
parser.path <- file.path('inst', 'parsers', 'MSCI-WI.R')
source(parser.path)
# NOTE: 
# - in place of 'GSCI' we use 'CM.MARKET'
# - in place of 'BOND' we use 'FI.MARKET'
parser.path <- file.path('inst', 'parsers', 'CFP.R')
source(parser.path)
FI.MARKET <- CFP[, 'FI.MARKET']
CM.MARKET <- CFP[, 'CM.MARKET']
# VME
parser.path <- file.path('inst', 'parsers', 'VME-Factors.R')
source(parser.path)
VME.FACTORS <- VME.Factors[, c('DATE', 'VAL.EVR', 'MOM.EVR')]
VME.FACTORS <- xts::xts(VME.FACTORS[, -1], order.by=VME.FACTORS$DATE)
# FFC factors
FF3 <- ExpectedReturns::GetFactors('FF3', freq='monthly')
MOM <- ExpectedReturns::GetFactors('MOM', freq='monthly')
min.tp <- max(first(index(FF3)), first(index(MOM)))
max.tp <- min(last(index(FF3)), last(index(MOM)))
days.diff <- diff(seq.Date(min.tp, max.tp, by='month'))[-1]
ff.dates <- c(min.tp, min.tp + cumsum(as.numeric(days.diff)))
# VIX Index
parser.path <- file.path('inst', 'parsers', 'VIX-FRED.R')
source(parser.path)
VIX.RET <- VIX.cls.monthly$VIX.RET
# TODO: VIX top 20%
# VIX20
# TED Spread
parser.path <- file.path('inst', 'parsers', 'TED-Spread.R')
source(parser.path)
colnames(TED.SPREAD) <- 'TED'
# TODO: TED top 20%
# TED20 
```

```{r Prepare data set}
# FFC4 factors
FFC4 <- merge(FF3[ff.dates, ], MOM[ff.dates, ])
# MSCI World Index
data <- merge(MSCI.WI$RET, FFC4)
data$MSCI.RET <- zoo::na.fill(data$RET, c(NA, 'extend', 'extend'))
data$MSCI.RF <- data$MSCI.RET - data$RF
data$RET <- NULL

# Bonds factors data
# data <- merge(CRP, data)
# data$GOVT.XS <- na.fill(data$GOVT.XS, c(NA, 'extend', NA))
# data$CORP.XS <- na.fill(data$CORP.XS, c(NA, 'extend', NA))
# Convert data set
# data <- data.frame(
#   DATE=ff.dates,
#   data[ff.dates, c(colnames(CRP), 'MSCI.RF', colnames(FFC4))],
#   row.names=NULL
# )
# tp <- 1:max(which(!is.na(data$CORP.XS)))
# data <- data[tp, ]

# Bonds factor
data <- merge(data, FI.MARKET)
# Commodities Market
data <- merge(data, CM.MARKET)
# VME factors
data <- merge(data, VME.FACTORS)
# VIX Index
data <- merge(data, VIX.RET)
# TED Spread
data <- merge(data, TED.SPREAD)
# TSMOM(12, 1) strategy returns
data <- merge(data, TSM)

# NOTE:
# All series are considered relative to FF dates, which are at month-end.
# Usually dates mismatch of one day day exists around the month-end.
# For a wide range of reasons, among which publication dates 
# discrepancies or later corrections. 
# When this happens we linearly interpolate values so to be able to uniquely 
# refer to the month-end (at which most series are normally disclosed). 
data <- apply(data, 2, zoo::na.fill, fill=c(NA, 'extend', NA))
data <- xts::xts(data, order.by=as.Date.character(rownames(data)))
data <- data.frame(
  DATE=ff.dates,
  data[ff.dates, ],
  row.names=NULL
)
```

```{r TSM Table 2 Time-series Regressions}
# Indexes
date.id <- matrix(1:nrow(data), dimnames=list(NULL, 'DATE.ID'))
data <- cbind(data, date.id)
# Regressions variables
y <- colnames(TSM[, -1])
X <- c('MSCI.RF', 'CM.MARKET', 'FI.MARKET', 'SMB', 'HML', 'MOM')
# Time-series regressions
tsmom.ts.reg <- lapply(1:length(y), function(x) {
  model.formula <- formula(
    paste(
      y[x], paste(X, collapse='+'), 
      sep='~'
    )
  )
  plm::plm(
    model.formula, data=data,
    model='pooling', index='DATE.ID'
  )
})
lapply(tsmom.ts.reg, summary)
```

```{r TSM Table 3 Time-series Regressions}
# NOTE:
# for the last three models we run regressions on monthly series as opposed to 
# quarterly data.
y <- 'TSMOM' # diversified TSMOM(12,1)
X <- list(
  ffc4.msci=c('MSCI.RF', 'SMB', 'HML', 'MOM')
  , amp3=c('MSCI.RF', 'VAL.EVR', 'MOM.EVR')
  , msci=c('MSCI.RF', 'I(MSCI.RF^2)')
  , ted=c('TED') # TODO: add 'TED20'
  , vix=c('VIX.RET') # TODO: add 'VIX20'
)
tsmom.div.ts.reg <- lapply(X, function(x) {
  model.formula <- formula(
    paste(
      y, paste(x, collapse='+'), 
      sep='~'
    )
  )
  plm::plm(
    model.formula, data=data,
    model='pooling', index='DATE.ID'
  )
})
lapply(tsmom.div.ts.reg, summary)
```


# Time series momentum factor
Let us consider the TSMOM(12, 1) strategy, aggregating returns across all asset classes holds a portfolio called *diversified TSMOM factor* and expressed as
$$
r_{t,t+1}^{\textrm{TSMOM}} = \frac{1}{S_t}\sum_{s=1}^{S_t}\textrm{sign}(r_{t-12,t}^{s})\frac{40\%}{\sigma_t^s}r_{t,t+1}^{s}
$$
with $S_t$ securities investable at time $t$ and a 40% constant annual volatility is chosen by authors because "it is similar to the risk of an average individual stock" and to "make it easier to intuitively compare our portfolios to other in the literature" as, it is consistent with other factors' volatility once averaged over securities.

# Time series momentum vs. cross-sectional momentum
Analyses comparing time series momentum and the cross-sectional momentum of \textcite{asness-moskowitz-pedersen-2013}.
