---
title: '"Improving Time-Series Momentum Strategies: The Role of Trading Signals and Volatility Estimators"'
subtitle: "(draft)"
author: "Vito Lestingi"
date: "`r Sys.Date()`"
abstract: "This document includes replication material on some academic and practitioners' literature instrumental for our RGSoC 2020 project. The document itself is meant to be completely reproducible."
output:
  rmarkdown::pdf_document:
    citation_package: biblatex
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{"Improving Time-Series Momentum Strategies: The Role of Trading Signals and Volatility Estimators"}
  %\VignetteEngine{rmarkdown::render}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_knit$set(
  root.dir = normalizePath('..')
)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  warning = FALSE,
  error = FALSE
)
```

# Introduction
These notes aim at reproducing \textcites{baltas-kosowski-2012, baltas-kosowski-2013}. The work has three fundamental aims:
first of all, to document empirical time-series momentum patterns, second to examine the information content of traditional and new signals to capture assets' momentum and third, to investigate a family of volatility estimators and assess their efficiency from a momentum investing point of view.

# Data and methodology
Data series we analyze are obtained from Bloomberg. For reproducibility purposes, we made efforts to re-create a data set as similar as possible to the one studied by \textcite{baltas-kosowski-2012}. Their data set consists of intra-day future prices of 12 classes of futures contracts, at a 30 minutes frequency. We analyze daily data on the same set of instruments. Next to the asset, for reference we also indicate Bloomberg tickers, class and the Exchange where the symbol considered is traded at. Futures contracts include: 6 commodities futures, among which Cocoa (`CC1`, Agricultural, ICE), Wheat (`W1`, Agricultural, CBOT), Crude Oil (`CL1`, Energy, CBOT), Natural Gas (`NG1`, Energy, Nymex), Copper (`HG1`, Industrial Metals, Comex), and Gold (`GC1`, Precious Metals, Comex); 2 equity indexes, S&P500 (`SPX`) and Eurostoxx50 (`SX5E`); 2 FX rates: US Dollar Index (`DX1`) and EUR/USD (`EC1`?); lastly, 2 interest rates: 3-month Eurodollar deposits (`ED1`) and 10-year US T-Note (`TY1`). 

Of methodological relevance is that authors adjust futures quotes series for rollovers, so to limit attention to the most liquid contract per instrument. Our data set is simpler, in that it only contemplates each instrument traded in a single Exchange, as indicated above. In addition, authors have to align among the various Exchanges where contracts are traded in order to avoid the introduction of undue lead-lag effects in the analyses. Because our data set consists of daily data this step does not apply and we only refer to a end-of-day characterization of (all) markets. It should be clear that authors' framework is more rigorous, especially in sight of volatility estimations where high-frequency data aim at more or less drastically reduce microstructure noise. Unfortunately we do not have readily available intra-day time-series and therefore use daily data.

Furthermore, as will be better detailed in following sections, we consider daily settlement futures prices as opposed to closing prices (see [CME Group Daily Settlement Procedures](https://www.cmegroup.com/market-data/files/CME_Group_Settlement_Procedures.pdf) for information). This is chiefly dictated by the fact closing price data is not readily available in our data set. However, we observe that often the two series are row-wise equal and when they're not prices result to be quite close indeed. However, there are important conceptual differences between the two and thus this "substitution" shouldn't take place when full OCHL data is available. 

```{r Load/source futures data}
# Commodities, equity indexes, currencies, and interest rates
# TODO: Eurostoxx50 in USD?
# TODO: 'EC1' for EUR/USD FX rate?
LoadFuturesData <- function(symbols) {
  #' @param symbols A character vector, specifying symbols to be loaded from `sandbox/data/FuturesData/`. 
  #'                Must match corresponding `.RData` files names
  symbols.files <- normalizePath(
    list.files(
      file.path('sandbox', 'data', 'FuturesData'), 
      pattern="*.RData", recursive=TRUE, full.names=TRUE
    )
  )
  symbols.files.avail <- unlist(
    strsplit(
      basename(symbols.files), split='.RData'
    )
  )
  sm <- match(symbols, symbols.files.avail)
  for (symbol.file in symbols.files[sm]) {
    load(symbol.file, envir=globalenv())
  }
}
symbols <- c('CC1', 'CL1', 'DX1', 'EC1', 'ED1', 'GC1', 'HG1', 'NG1', 'SPX', 'SX5E', 'TY1', 'W 1')
LoadFuturesData(symbols)
```

```{r Prepare data sets}
# Convert to data.frame
futures.data <- mget(symbols)
symbols.vars <- c('Open', 'High', 'Low', 'Close', 'Volume', 'Open.Interest')
futures.data <- lapply(futures.data, function(x) {
  # For all but equity indexes, 'Close' (closing price) is in reality 'Settle' (daily settlement price).
  # For the majority of instruments we do not have closing prices readily available at this time. 
  # Renaming is chiefly due to computational and illustration convenience.
  colnames(x) <- symbols.vars[1:ncol(x)]
  # Returns
  x$Return <- PerformanceAnalytics::Return.calculate(x$Close, 'discrete')
  x$Comp.Return <- PerformanceAnalytics::Return.calculate(x$Close, 'log')
  data.frame(
    Date=zoo::index(x), 
    zoo::coredata(x)
  )
})
# Assign tickers' names
futures.data <- mapply(function(x, y) {
  x$Symbol <- rep(y, nrow(x))
  return(x)
}, futures.data, symbols)

# Make panel 
futures.data.panel <- Reduce(function(...) merge(..., all=TRUE), futures.data)
```

# Time-series Momentum Strategies
Time-series momentum is defined analogously to \textcite{moskowitz-ooi-pedersen-2012}. Generally, *univariate time-series momentum* is the trading rule that imposes to take a long/short position on a given asset depending on a metric of its past performance. The rule is completely identified by two parameters, namely the *lookback period* $J$ over which such performance is taken into account and the *holding period* $K$ during which the asset is effectively held in the portfolio. Since the same holds in principle for every tradable assets, time-series momentum can and is also be aggregated at portfolio level. Adopting \textcite{baltas-kosowski-2012} symbols and notation for readability purposes, such quantity is expressed as
$$
R^{\textrm{TS}}(t,t+K) = \sum_{i=1}^{M} X_{i}(t-J, t) \frac{10\% / \sqrt{M}}{\sigma_{i}(t,D)} R_{i}(t,t+K)
$$
where $M$ is the number of available assets, $X_{i}(t-J, t)$ the momentum signal, $\sigma_{i}(t,D)$ the volatility estimates, and $\sqrt{M}$ is the scaling factor used in order to achieve a 10% ex-ante volatility.

The outline of subsections is as follows. First of all, in order to compute the above quantity we need a momentum signal and a volatility estimator. Each class of such elements shall receive individual treatment: many alternatives have consolidated in decades of research, each presents pros and cons by its own and in relation with the objectives of the particular study we aim to replicate.

## Volatility estimation
Traditional daily volatility estimators, like the standard deviation of daily past returns, provide relatively noisy volatility estimates. Authors study volatility estimators, the **realized variance** of \textcite{andersen-bollerslev-1998} and **volatility range estimators** including the estimators of \textcites{parkinson-1980, garman-klass-1980, rogers-satchell-1991, yang-zhang-2000}. 

Denote $S_{o}(t)$, $S_{h}(t)$, $S_{l}(t)$, $S_{c}(t)$ for the opening, high, low, and closing prices in the time period $t$, for a given asset. In other words, the asset OHLC data. Variance estimators investigated are defined as follows, volatility being the square root.

1. **Realized variance (RV)**  
$$
\sigma_{\textrm{RV}}^{2}(t) = \sum_{t}^{T}R_{t}^{2}
$$
with $R_{t}$ the continuously compounded returns.

2. **Parkinson estimator (PK)**  
$$
\sigma_{\textrm{PK}}^{2}(t) = \frac{1}{4 \ln{2}}[S_{h}(t) - S_{l}(t)]^2
$$
3. **Garman-Klass estimator (GK)**  
$$
\sigma_{\textrm{GK}}^{2}(t) = \frac{1}{2}[S_{h}(t) - S_{l}(t)]^2 - (2\ln{2} - 1)S_{c}^{2}(t)
$$
4. **Garman-Klass-Yang-Zhang estimator (GKYZ)**  
Yang-Zhang modification of the Garman-Klass estimator.
$$
\sigma_{\textrm{GKYZ}}^{2}(t) = \sigma_{\textrm{GK}}^{2}(t) + [S_{o}(t) - S_{c}(t - 1)]^2
$$
5. **Rogers-Satchell estimator (RS)**  
$$
\sigma_{\textrm{RS}}^{2}(t) = S_{h}(t)[S_{h}(t) - S_{c}(t)] + S_{l}(t)[S_{l}(t) - S_{c}(t)]
$$
6. **Yang-Zhang estimator (YZ)**  
$$
\sigma_{\textrm{YZ}}^{2}(t) = \sigma_{o}^{2}(t, D) + k\sigma_{\textrm{STDEV}}^{2}(t, D) + (1 - k)\sigma_{\textrm{RS}}^{2}(t, D)
$$
where $\sigma_{o}^{2}(t, D)$ is the variance of opening prices over a $D$ time period, annualized with respect to a given year of 261 trading days. The parameter $k$ is chosen so to minimize the variance of the estimator.

To compute volatility estimations we use functionality provided in the `TTR` package, `TTR::volatility()` specifically.

To assess volatility estimates efficiency, authors assume $\sigma_{\textrm{RV}}$ as the "true" volatility and compute for the generic estimator $\sigma_{0}$ a bias
$$
\textrm{BIAS} = \frac{1}{T - D}\sum_{t=D}^{T}[\sigma_{\textrm{RV}} - \sigma_{0}]
$$
with $T$ the total number of observations in the sample period and $D$ the time period over which volatility estimates are based.

Also, in order to assess volatility estimates persistence and to investigate the role of volatility estimators choice on portfolio turnover, authors compute the *volatility turnover* (VTO). This quantity is expressed as
$$
\textrm{VTO} = \frac{1}{T - D - 1} \sum_{t = D+1}^{T} \Bigl| \frac{1}{\sigma{(t, D)}} - \frac{1}{\sigma{(t-1, D)}} \Bigr|
$$

```{r Volatility estimators}
vol.estimators <- c('close', 'parkinson', 'garman.klass', 'gk.yz', 'rogers.satchell', 'yang.zhang')
EstimateVolatility <- function(X, estimator, ...) {
  vol.estm <- vol.bias <- vol.abrd <- vto <- vector('list', length(estimator))
  vol.calcs <- lapply(X, function(x) {
    # Get dates, OHLC prices, and convert
    x <- x[, 1:5]
    x <- x[, !vapply(x, is.character, FUN.VALUE=logical(1L))]
    x <- xts(x[, -1], order.by=x[, 1])
    for (v in 1:length(estimator)) {
      vol.estm[[v]] <- TTR::volatility(x, calc=estimator[v], ...) 
      vol.bias[[v]] <- 1 / nrow(x) * sum(vol.estm[[1]] - vol.estm[[v]], na.rm=TRUE)
      vol.abrd[[v]] <- abs((1 / vol.estm[[v]]) - (1 / lag(vol.estm[[v]])))
      vto[[v]] <- 1 / (nrow(x) + 1) * sum(vol.abrd[[v]], na.rm=TRUE)
    }
    out <- list(vol.est=vol.estm, vol.bias=vol.bias, vol.abrd=vol.abrd, vto=vto)
    out <- lapply(out, function(x) setNames(x, estimator))
    return(out)
  })
  return(vol.calcs)
}

# 30-days volatility estimates
vol30 <- EstimateVolatility(
  lapply(futures.data, zoo::na.locf), estimator=vol.estimators,
  n=30, N=261, type='continuous'
)
# 60-days volatility estimates
vol60 <- EstimateVolatility(
  lapply(futures.data, zoo::na.locf), estimator=vol.estimators, 
  n=60, N=261, type='continuous'
)
```

```{r Table 2}
avg.bias <- avg.abrd <- matrix(
  NA, length(vol60), length(vol.estimators), 
  dimnames=list(names(vol60), vol.estimators)
)
for (a in 1:length(vol60)) {
  # Panel B
  # Annualized volatility estimators bias across futures contracts
  # NOTE: assuming close-to-close is the "true" volatility
  avg.bias[a, ] <- vapply(vol60[[a]]$vol.bias, mean, FUN.VALUE=double(1L), na.rm=TRUE)
  # Panel C
  # Average absolute reciprocal volatility change across futures contracts
  avg.abrd[a, ] <- vapply(vol60[[a]]$vol.abrd, mean, FUN.VALUE=double(1L), na.rm=TRUE)
}
```

## Momentum signals
Authors empirically investigate five momentum signals, summarized below. All the signals may possibly result in a value in the set $\{-1, 0, 1\}$, for short, inactive, and long positions, respectively.

1. **Return Sign (SIGN)**  
This momentum measurement has been proposed since the first studies documenting *momentum* anomaly. In the time-series momentum literature, it was introduced by \textcite{moskowitz-ooi-pedersen-2012} and consists in the past returns sign. 
$$
\textrm{SIGN(t-J, t)} = 
\begin{cases} 
+1 & R(t-J, t) > 0\\
-1 & \text{otherwise}
\end{cases}
$$

2. **Moving Average methodology (MA)**  
The signal is generated depending on the relationship between a short-term moving average of the asset prices and a longer-term one, over the lookback period. This market-timing feature is a peculiarity of this methodology, in contrast to the other signals studied.
$$
\textrm{MA(t-J, t)} = 
\begin{cases} 
+1 & A_{J}(t) < A_{1}(t)\\
-1 & \text{otherwise}
\end{cases}
$$

3. **Time-Trend t-statistic (TREND)**  
t-statistic of the slope coefficient from a least-squares fit of a linear trend on the asset price.
$$
\textrm{TREND(t-J, t)} = 
\begin{cases} 
+1 & t(\beta) > +2\\
-1 & t(\beta) < -2\\
 0 & \text{otherwise}
\end{cases}
$$

4. **Statistically Meaningful Trend (SMT)**
A more robust version of the previous signal, it is represented by the statistically meaningful trend methodology of \textcite{bryhn-dimberg-2011}.
$$
\textrm{SMT(t-J, t)} = 
\begin{cases} 
+1 & t(\beta) > +2, R^2 > 0.65 \\
-1 & t(\beta) < -2, R^2 > 0.65\\
 0 & \text{otherwise}
\end{cases}
$$

5. **Ensemble Empirical Mode Decomposition (EEMD)**
This signal processing technique was proposed by \textcite{wu-huang-2009}. \textcite{baltas-kosowski-2012} apply the methodology to extract assets' price trends.
$$
\textrm{EEMD(t-J, t)} = 
\begin{cases} 
+1 & p(t) > p(t-J) \\
-1 & \textrm{otherwise}
\end{cases}
$$

To notice is that TREND and SMT are the only signals that can result in inactive positions. Further, given that SMT is more restrictive than TREND, it tends to hold more frequent or longer inactivity periods.   

```{r TSMOM strats signals}
# 12 months lookback as 261 trading days
mom.sign <- ExpectedReturns::MomSignal(futures.data, lookback=261, signal='SIGN')
mom.ma <- ExpectedReturns::MomSignal(futures.data, lookback=261, signal='MA')
```

Also, to each momentum signal can be associated a so called *momentum speed*, which is an activity to turnover-ratio and is used to assess signals trading intensity. Letting $X(t)$ the momentum signal in $t$, its speed is defined as
$$
\textrm{SPEED}_{X} = \sqrt{\frac{\textrm{E}[X^2]}{E[(\Delta X)^2]}} 
= \sqrt{\frac{\frac{1}{T-J}\sum_{t=1}^{T}X^{2}(t-J,t)}{\frac{1}{T-J-1}\sum_{t=1}^{T}[X(t-J,t) - X(t-J-1,t-1)]^2}}
$$
where $\textrm{E}[X]$ is the expected value of the momentum signal. The higher the speed, the larger the signal activity and thus the portfolio turnover.

### Returns predictability
Generally speaking, trading a given future contract or a portfolio based on momentum signals detailed above leads to more or less different returns streams. 
Following \textcite{baltas-kosowski-2012} we run time-series regression to assess the relationship between the signal and the returns generated by the strategy. The analysis is repeated at several horizons. In other words, we now quantitatively study what in these literature strains is informally referred to as signal's "predictive capability" or "predictive power".

## Time-series momentum strategies performance
In order to evaluate time-series momentum strategies performance, we examine the time-series return predictability using a pooled panel regression and a set of measures, namely the simple arithmetic average return, dollar growth, the Sharpe ratio and the (symmetric) downside-risk Sharpe ratio of \textcite{ziemba-2005}.
